

- name: Install
  become: yes
  block:
    - name: "Create the group {{ backend_user_group }}"
      group:
        name: '{{ backend_user_group }}'
        state: present
    - name: "Create the user {{ backend_user_name }}"
      user:
        name: '{{ backend_user_name }}'
        comment: User for the backend app
        shell: /bin/bash
        state: present
        group: '{{ backend_user_group }}'
        password: "{{ backend_user_pwd | password_hash('sha512') }}"
    - name: Create the install path {{ backend_install_path }}
      file:
        state: directory
        path: '{{ backend_install_path }}'
        group: '{{ backend_user_name }}'
        owner: '{{ backend_user_group }}'
        mode: 'u=rwx,g=rwx,o='
    - name: Create the cache dir
      file:
        state: directory
        path: '{{ backend_cache_dir }}'
        group: '{{ backend_user_name }}'
        owner: '{{ backend_user_group }}'
        mode: 'u=rwx,g=rwx,o='
    - name: Populate service data
      service_facts:
    - name: Stop {{ backend_app_name }}
      when: backend_app_name in services
      systemd:
        state: stopped
        name: '{{ backend_app_name }}'
    - name: Delete the jar (Hack because we are for now deploying a snapshot jar that has always the same name)
      file:
        state: absent
        path: '{{ backend_install_path }}/bytle-api-0.0.1-SNAPSHOT-all.jar'
    - name: Download the fat jar
      maven_artifact:
        group_id: net.bytle
        artifact_id: bytle-api
        version: 'latest'
        classifier: all
        repository_url: '{{ backend_repository_url }}'
        username: '{{ backend_repository_user }}'
        password: '{{ backend_repository_pwd }}'
        dest: '{{ backend_install_path }}/'
        group: '{{ backend_user_name }}'
        owner: '{{ backend_user_group }}'
        state: present
        keep_name: yes
        mode: 'u=rwx,g=rx,o=rx'
      register: maven_download
    - name: 'Set the downloaded jar path (used in the service template)'
      set_fact:
        backend_fat_jar_path: '{{ maven_download.dest }}'
    - name: Copy the systemd backend.service file
      register: service_file
      template:
        src: '{{backend_app_name}}.service'
        dest: '/etc/systemd/system/{{backend_app_name}}.service'
        mode: 0644
    - name: Copy the sudoer file
      template:
        src: '{{backend_app_name}}.sudoer'
        dest: '/etc/sudoers.d/{{backend_app_name}}'
        mode: 0750
    # Not in the handlers because handler happens at the end
    - name: 'backend reload when the service file has changed'
      when: service_file is changed
      systemd:
        name: '{{ backend_app_name }}.service'
        enabled: 'yes'
        daemon_reload: yes
        state: restarted
    - name: Verify that the service {{ backend_app_name }} is up
      systemd:
        state: started
        name: '{{ backend_app_name }}'
    - name: Test that the service is up
      uri:
        url: http://localhost:8083/ip/143.176.206.80
        method: GET
      register: ipcall
      until: ipcall.status == 200
      delay: 5 # Every 5 seconds
      retries: 5 # 5 * 5 seconds = 25
