
- name: Check if the PostgreSQL repo is available
  ansible.builtin.stat:
    path: "/etc/yum.repos.d/pgdg-redhat-all.repo"
  register: postgres_repo

- name: Install Postgres repo
  when: not postgres_repo.stat.exists
  ansible.builtin.yum:
    name: https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm
    state: present

- name: Install Postgres 15
  ansible.builtin.yum:
    name: postgresql15-server
    state: present

# Contrib is the package providing additional modules
# All this extension
# and hstore ?:
# https://www.postgresql.org/docs/current/contrib.html
# It will resolve this error:
# Could not open extension control file "/usr/pgsql-15/share/extension/hstore.control"
- name: Install the extensions (hstore)
  ansible.builtin.yum:
    name: postgresql15-contrib
    state: present

- name: Postgres | python-psycopg2 (used by the postgres ansible module)
  ansible.builtin.yum:
    name: python-psycopg2
    state: present

# https://www.postgresql.org/docs/15/creating-cluster.html
- name: Database Init (create the files, does not start)
  block:
    - name: Check if PostgreSQL is initialized
      ansible.builtin.stat:
        path: "{{ pg_data }}/postgresql.conf"
      register: postgres_conf

    # initdb â€” create a new PostgreSQL database cluster
    # A database cluster is a collection of databases that are managed by a single server instance.
    # https://www.postgresql.org/docs/current/app-initdb.html
    - name: Initialize a PostgreSQL instance
      ansible.builtin.shell: "{{ pg_bin }}/postgresql-15-setup initdb --pgdata {{ pg_data }}"
      when: not postgres_conf.stat.exists


- name: Postgres | Enable service
  ansible.builtin.service:
    name: postgresql-15
    enabled: true



