

- name: Install
  become: yes
  block:
    - name: "Create the group {{ gnico_user_group }}"
      group:
        name: '{{ gnico_user_group }}'
        state: present
    - name: "Create the user {{ gnico_user_name }}"
      user:
        name: '{{ gnico_user_name }}'
        comment: User for the gerarnico app
        shell: /bin/bash
        state: present
        group: '{{ gnico_user_group }}'
    - name: Create the install path {{ gnico_install_path }}
      file:
        state: directory
        path: '{{ gnico_install_path }}'
        group: '{{ gnico_user_name }}'
        owner: '{{ gnico_user_group }}'
        mode: 'u=rwx,g=rx,o=r'
#    - name: Add mappings to /etc/hosts
#      blockinfile:
#        path: /etc/hosts
#        block: |
#          {{ item.ip }} {{ item.name }}
#        marker: "# {mark} ANSIBLE MANAGED BLOCK {{ item.name }}"
#      loop:
#        - { name: '{{ gnico_fat_host }}', ip: 127.0.0.1 }

    - name: Download the fat jar
      maven_artifact:
        group_id: net.bytle
        artifact_id: bytle-api
        version: latest
        classifier: all
        repository_url: '{{ gnico_repository_url }}'
        username: '{{ gnico_repository_user }}'
        password: '{{ gnico_repository_pwd }}'
        dest: '{{ gnico_install_path }}/'
        group: '{{ gnico_user_name }}'
        owner: '{{ gnico_user_group }}'
        state: present
        keep_name: yes
        mode: 'u=rwx,g=rx,o=r'
      register: maven_download
    - name: 'Get and set the downloaded latest jar path'
      set_fact:
        gnico_fat_jar_path: '{{ maven_download.dest }}'
    - name: Copy the systemd nexus.service file
      template:
        src: gnico.service
        dest: /etc/systemd/system/gnico.service
        mode: 0644
      notify:
        - 'gnico reload'

