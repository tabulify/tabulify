# From
# https://www.modpagespeed.com/doc/build_ngx_pagespeed_from_source
# based on
# psol: https://developers.google.com/speed/pagespeed/psol
# PageSpeed Optimization Libraries
#

- name: Install pagespeed dependencies package
  yum:
    name:
      - gcc-c++
      - pcre-devel
      - zlib-devel
      - make
      - unzip
      - libuuid-devel
    state: present

- name: Create temporary directory for pagespeed
  file:
    state: directory
    path: '{{ nginx_build_base_dir }}'

- name: Download Nginx Pagespeed module
  uri:
    url: 'https://github.com/apache/incubator-pagespeed-ngx/archive/{{ nginx_pagespeed_archive }}'
    method: GET
    dest: '{{ nginx_build_base_dir }}/{{ nginx_pagespeed_archive }}'
    creates: '{{ nginx_build_base_dir }}/{{ nginx_pagespeed_archive }}'

- name: Extract Pagespeed archive
  unarchive:
    src: '{{ nginx_build_base_dir }}/{{ nginx_pagespeed_archive }}'
    dest: '{{ nginx_build_base_dir }}'
    remote_src: yes
    creates: '{{ nginx_build_base_dir }}/{{ nginx_pagespeed_archive_dir_name }}'


# The bitsize name is part of the downloaded URL
# You can see it into cat ./scripts/format_binary_url.sh
- name: Set the bit size name if 64
  when: ansible_userspace_bits == "64"
  set_fact:
    bit_size_name: x64
- name: Set the bit size name if not 64
  when: ansible_userspace_bits != "64"
  set_fact:
    bit_size_name: ia32

- name: Download the PageSpeed Optimization Libraries (PSOL)
  uri:
    url: 'https://dl.google.com/dl/page-speed/psol/{{ nginx_psol_archive }}'
    method: GET
    dest: '{{ nginx_build_base_dir }}/{{ nginx_pagespeed_archive_dir_name }}/{{ nginx_psol_archive }}'
    creates: '{{ nginx_build_base_dir }}/{{ nginx_pagespeed_archive_dir_name }}/{{ nginx_psol_archive }}'

- name: Extract the PageSpeed Optimization Libraries
  unarchive:
    src: '{{ nginx_build_base_dir }}/{{ nginx_pagespeed_archive_dir_name }}/{{ nginx_psol_archive }}'
    dest: '{{ nginx_build_base_dir }}/{{ nginx_pagespeed_archive_dir_name }}'
    remote_src: yes
    creates: '{{ nginx_build_base_dir }}/{{ nginx_pagespeed_archive_dir_name }}/psol'

- name: Compile and copy
  import_tasks: nginx_compile_dynamic_module.yml
  vars:
    nginx_dynamic_library_name: 'ngx_pagespeed.so'
    nginx_dynamic_library_source_path: '{{ nginx_build_base_dir }}/{{ nginx_pagespeed_archive_dir_name }}'

