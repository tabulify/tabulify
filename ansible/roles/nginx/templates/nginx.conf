# For more information on configuration, see:
#   * Official English Documentation: http://nginx.org/en/docs/
#   * Official Russian Documentation: http://nginx.org/ru/docs/

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

# Module
load_module "modules/{{ nginx_pagespeed_module_file_name }}";
load_module "modules/{{ nginx_status_module_file_name }}";

# Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.
# See also the two above
include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 1024;
}

http {


    access_log  /var/log/nginx/access.log;

    # https://github.com/vozlt/nginx-module-vts
    vhost_traffic_status_zone;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    types_hash_max_size 2048;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    # share ssl parameters
    # based on
    # http://nginx.org/en/docs/http/ngx_http_ssl_module.html - example config
    # https://github.com/certbot/certbot/blob/master/certbot-nginx/certbot_nginx/_internal/tls_configs/options-ssl-nginx.conf
    keepalive_timeout   70;
    ssl_session_cache shared:http:10m;
    ssl_session_timeout  1440m;
    ssl_session_tickets off;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;
    ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384";

    # Real IP restoration
    # https://support.cloudflare.com/hc/en-us/articles/200170786-Restoring-original-visitor-IPs
    # https://www.cloudflare.com/ips/
    # https://www.cloudflare.com/ips-v4
    # http://nginx.org/en/docs/http/ngx_http_realip_module.html
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 131.0.72.0/22;
    # https://www.cloudflare.com/ips-v6
    set_real_ip_from 2400:cb00::/32;
    set_real_ip_from 2606:4700::/32;
    set_real_ip_from 2803:f800::/32;
    set_real_ip_from 2405:b500::/32;
    set_real_ip_from 2405:8100::/32;
    set_real_ip_from 2a06:98c0::/29;
    set_real_ip_from 2c0f:f248::/32;
    #
    real_ip_header X-Forwarded-For;
    real_ip_recursive on;

    # No host field is not allowed
    # http://nginx.org/en/docs/http/request_processing.html
    server {
            listen      80 default_server;
            server_name "";
            return      444;
    }

    # Limit rate (see rate_limiting.md)
    limit_req_zone $binary_remote_addr zone={{ nginx_rate_limiting_zone }}:10m rate={{ nginx_rate_limiting_frequency }};
    limit_req_zone $binary_remote_addr zone={{ nginx_rate_limiting_zone_registration }}:1m rate={{ nginx_rate_limiting_frequency_registration }};

    # Load server modular configuration files from the /etc/nginx/conf.d directory.
    # See http://nginx.org/en/docs/ngx_core_module.html#include
    # for more information.
    include {{ nginx_etc_path_conf }}/http/*.conf;


}

# Test
# openssl s_client -connect drill.bytle.net:31009 -showcerts
#
stream {

    # http://nginx.org/en/docs/stream/ngx_stream_log_module.html
    log_format main '$remote_addr [$time_local] '
                     '$protocol $status $bytes_sent $bytes_received '
                     '$session_time';

    # share ssl parameters
    # based on
    # https://github.com/certbot/certbot/blob/master/certbot-nginx/certbot_nginx/_internal/tls_configs/options-ssl-nginx.conf
    # not the cache cannot be shared between a http and stream block
    # the cache is therefore shared:tcp:10m and not shared:http:10m
    ssl_session_cache shared:tcp:10m;
    ssl_session_timeout  4h;
    ssl_session_tickets off;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;
    ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384";
    ssl_handshake_timeout 10s;

    include {{ nginx_etc_path_conf }}/tcp/*.conf;

}
