---

- name: Ensure postfix is installed.
  package:
    name: postfix
    state: present

- name: Ensure sendmail is not
  package:
    name: sendmail
    state: absent

- name: Install a local client mail
  package:
    name: mailx
    state: present

- name: Update Postfix configuration.
  notify: restart postfix
  lineinfile:
    dest: "{{ postfix_conf_path }}"
    line: "{{ item.name }} = {{ item.value }}"
    regexp: "^[#]{0,1}{{ item.name }}"
  with_items:
    - name: mydestination # store email only for this domain (this is the default)
      value: "$myhostname, localhost.$mydomain, localhost"
    - name: inet_interfaces  # The  network interface  addresses that this system receives mail on.
      value: "localhost"
    - name: myhostname # The internet hostname of this mail system.
      value: "{{ hostname }}"
    - name: mydomain
      value: "bytle.net"
    - name: myorigin # append to email without domain. The domain name that locally-posted mail appears to come from, and that locally posted mail is delivered to.
      value: "$mydomain"
    - name: mynetworks_style # trusted network addresses are specified by subnet
      value: "subnet"
    - name: mynetworks # The list of "trusted" remote SMTP clients that have more  privileges than "strangers".
      value: "127.0.0.1/32 143.176.206.82/32"
    - name: relay_domains # don't relay mail from other hosts. safe: never forward mail from strangers
      value: ""
    - name: relayhost # direct delivery to Internet
      value: ""

- name: Ensure postfix is started and enabled at boot.
  service:
    name: postfix
    state: started
    enabled: true

- name: 'Firewalld - Add port 25'
  become: true
  firewalld:
    port: '25/tcp'
    permanent: yes
    state: enabled
  notify: firewalld reload
