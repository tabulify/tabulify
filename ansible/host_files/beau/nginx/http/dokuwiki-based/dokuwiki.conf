
# General dokuwiki template used for dokuwuki website

# Root
# As stated https://www.php.net/manual/en/install.unix.nginx.php
# and here: https://www.nginx.com/resources/wiki/start/topics/recipes/dokuwiki/
# and here https://www.dokuwiki.org/tips:httpslogin#nginx
server {

    # Change `example.com` to match your domain name.
    server_name {{ fqdn }};

    # where are the files
    root   {{ bytle_farmer_root_dir }};

    # log the URL rewrite rule
    rewrite_log on;

    # the logs
    # doc: http://nginx.org/en/docs/debugging_log.html
    access_log  {{ nginx_log_path }}/{{ fqdn }}/https-access.log;
    # https://nginx.org/en/docs/ngx_core_module.html#error_log
    error_log  {{ nginx_log_path }}/{{ fqdn }}/https-error.log;

    # listen to
    listen       443 ssl http2;
    listen       [::]:443 ssl http2;

    # Compression
    # [Article] https://docs.nginx.com/nginx/admin-guide/web-server/compression/
    # [Reference] http://nginx.org/en/docs/http/ngx_http_gzip_module.html
    # [Good blog] https://www.digitalocean.com/community/tutorials/how-to-add-the-gzip-module-to-nginx-on-ubuntu-14-04
    gzip on;
    gzip_disable "msie6"; # not for IE6 :)
    # add other mediaType than html
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml;
    # minimal byte
    gzip_min_length 1000;
    gzip_comp_level 6;
    gzip_vary on;
    gzip_proxied any;

    # certificates
    ssl_certificate_key "{{ letsencrypt_cert_base_dir }}/{{ fqdn }}/privkey.pem";
    ssl_certificate "{{ letsencrypt_cert_base_dir }}/{{ fqdn }}/fullchain.pem";

    # wiki redirect
    location ~ /wiki/(.*) {
      # No fragments, see https://stackoverflow.com/questions/2286402/url-fragment-and-302-redirects
      # a call to https://datacadamia.com/wiki/feed.php should redirect
      return 301 $scheme://$host/$1$is_args$query_string;
    }

    # page 404
    # test https://datacadamia.com/lib/images/toolbar/https://datacadamia.com/lib/plugins/note/images/tb_tip.png
    # don't forget - fastcgi_intercept_errors http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html#fastcgi_intercept_errors
    error_page 404 /40x.html;
    error_page 444 /40x.html;

    # Serve
    # try files send $uri and $uri/ to the location block @dokuwiki
    location / {

        index  doku.php;

        # http://nginx.org/en/docs/http/ngx_http_core_module.html#try_files
        # If none of the files are found, an internal redirect to the uri specified in the last parameter is made.
        try_files $uri $uri/ @dokuwiki;

        # cors
        add_header 'Access-Control-Allow-Origin' 'https://fiddle.jshell.net';

    }

    # rewrite
    location @dokuwiki {
        rewrite ^/_media/(.*) /lib/exe/fetch.php?media=$1 last;
        rewrite ^/_detail/(.*) /lib/exe/detail.php?media=$1 last;
        rewrite ^/_export/([^/]+)/(.*) /doku.php?do=export_$1&id=$2 last;
        rewrite ^/(.*) /doku.php?id=$1 last;
    }


    # send the php file to php-fpm
    # doc, see http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html
    # example, see https://www.nginx.com/resources/wiki/start/topics/examples/phpfcgi/
    # this block proxy requests to PHP FPM via the FCGI protocol
    location ~ \.php$ {

        # $document_root$fastcgi_script_name =
        # /opt/www/datacadamia.com/doku.php
        # /opt/www/datacadamia.com/wp-login.php
        # add_header X-document-path "$document_root$fastcgi_script_name" always;

        # 404 if someone try a non-existent php file
        if (!-f $document_root$fastcgi_script_name) {
               return 444;
        }
        # not
        # fastcgi_intercept_errors on;
        # because it would send an error when the page does not exist on dokuwiki
        # and I don't know why.

        fastcgi_pass  127.0.0.1:{{ fpm_spool_www_port }};
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

        # as stated here: https://docs.newrelic.com/docs/apm/agents/php-agent/configuration/php-directory-ini-settings
        fastcgi_param PHP_VALUE "newrelic.appname={{ fqdn }}";

        include {{ nginx_etc_path }}/fastcgi_params;

        # rate limiting (see rate_limiting.md)
        limit_req zone={{ nginx_rate_limiting_zone }} burst={{ nginx_rate_limiting_burst }} delay={{ nginx_rate_limiting_delay }};
        limit_req_status {{ nginx_rate_limiting_status }};
        limit_req_log_level {{ nginx_rate_limiting_error_level }};

    }

    location ~ ^/lib.*\.(gif|png|ico|jpg|css)$ {
      expires 4h; # w3school and google are less than that
    }

    # Block access to data folders
    # Better if we return to doku.php ?
    location ~ ^/(data|conf|bin|inc)/.* {
      return 444; # deny all; # same as return 403
    }


    # Block access to .htaccess files
    location ~ /\.ht {
      return 444; # Better than ; deny  all; # same as return 403
    }

    # Upload size 1m default
    # http://nginx.org/en/docs/http/ngx_http_core_module.html#client_max_body_size
    client_max_body_size 3m;

}

# redirect to ssl
server {
    listen 80;
    server_name {{ fqdn }};
    return 301 https://{{ fqdn }}$request_uri;
    access_log  {{ nginx_log_path }}/{{ fqdn }}/http-access.log;
    error_log  {{ nginx_log_path }}/{{ fqdn }}/http-error.log;
}

# redirect www
server {
    listen 80;
    server_name www.{{ fqdn }};
    return 301 https://{{ fqdn }}$request_uri;
    access_log  {{ nginx_log_path }}/{{ fqdn }}/http-access-www.log;
    error_log  {{ nginx_log_path }}/{{ fqdn }}/http-error-www.log;
}

# redirect www
server {
    listen 443;
    server_name www.{{ fqdn }};
    return 301 https://{{ fqdn }}$request_uri;
    access_log  {{ nginx_log_path }}/{{ fqdn }}/https-access-www.log;
    error_log  {{ nginx_log_path }}/{{ fqdn }}/https-error-www.log;
}
