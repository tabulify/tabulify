version: '3'

tasks:
  # Update this repo with the copier-template
  # `--vcs-ref HEAD` to avoid `You are downgrading from 0.1.0.post2.dev0+0a9a33e to 0.1.0. Downgrades are not supported.`
  update:
    cmds:
      - |
        copier update --vcs-ref HEAD .
  # Install the package locally
  # * -DskipTests and not -Dmaven.test.skip so that test packaging is not skipped
  # * use --update-snapshots if the dependency pom was changed
  install:
    cmds:
      - mvnw install -DskipTests
  # Quick check to get all java docs error/warning
  # grep "error" to see only the errors
  javadoc:
    cmds:
      - mvnw javadoc:javadoc -q
  package:
    # -DskipTests and not -Dmaven.test.skip so that test packaging is not skipped
    cmds:
      - mvnw package -DskipTests
  # Run tests slow excluded (by default)
  test:
    cmds:
      # -P for profile name
      - |
        mvnw test -P default
  # Run all tests
  test-all:
    cmds:
      # -P for profile name
      - |
        mvnw test -P all-tests
  # Run slow tests
  test-slow:
    cmds:
      # -P for profile name
      - |
        mvnw test -P slow-tests-only
  # Install tabulify locally
  # the root `install` command install the jars
  install-cli:
    cmds:
      - |
        {{.TASKFILE_DIR}}/contrib/script/install-cli
  # Install the jars in the cli
  install-cli-jars:
    cmds:
      - |
        {{.TASKFILE_DIR}}/contrib/script/install-cli-jars
  # Just copy the howto resources to the client
  install-cli-resources:
    cmds:
      - |
        cp -r {{.TASKFILE_DIR}}/tabulify-cli/src/main/howto $CLI_TABUL_HOME/resources
        cp -r {{.TASKFILE_DIR}}/tabulify-gen-entities/src/main/resources/entity $CLI_TABUL_HOME/resources
  # Start the documentation website
  site-start:
    cmds:
      - |
        docker run \
        --name site-com-tabulify \
        --rm \
        -d \
        -p 8081:80 \
        --user 1000:1000 \
        -e DOKU_DOCKER_ENV=dev \
        -e DOKU_DOCKER_ACL_POLICY='public' \
        -e DOKU_DOCKER_ADMIN_NAME='admin' \
        -e DOKU_DOCKER_ADMIN_PASSWORD='welcome' \
        -e DOKU_DOCKER_BASE_URL='http://localhost:8081' \
        -v {{.TASKFILE_DIR}}/docs-tabul:/var/www/html \
        ghcr.io/combostrap/dokuwiki:php8.3-latest
          docker start site-com-combostrap
  # Broken links
  site-broken:
    cmds:
      - |
        docker exec -it site-com-tabulify php ./bin/plugin.php combo broken-links
  site-sync:
    # indexer will catch the double id, canonical problem
    # clear is mandatory otherwise you hit the cache
    # q just delete the normal output
    cmds:
      - |
        docker exec -it site-com-tabulify php ./bin/indexer.php --clear -q
        docker exec -it site-com-tabulify php ./bin/plugin.php combo sync :
  # Dump Front-matter into pages
  site-frontmatter:
    cmds:
      - |
        docker exec -it site-com-tabulify php ./bin/plugin.php combo metadata-to-frontmatter :
  # Unfortunately, JetBrains cannot read sqlite database
  # from wsl
  cp-sqlite:
    cmds:
      - |
        cp /home/admin/.tabul/sqlite.sqlite3 /mnt/c/tmp/tabul.db
  # Check the links on markdown. There is also a git pre-commit hooks
  links:
    cmds:
      - |
        markdown-link-check \
          --ignore target,vendor \
          --config {{.TASKFILE_DIR}}/contrib/config/markdown-lint-config.json \
          --quiet {{.TASKFILE_DIR}}
