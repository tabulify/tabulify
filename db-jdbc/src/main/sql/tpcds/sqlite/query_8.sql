
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '89435','30867','65085','22977','83927','77557',
                          '58429','40697','80613','10501','32779',
                          '91137','61265','98293','17921','18427',
                          '21203','59361','87291','84093','21505',
                          '17183','10865','67897','25797','28055',
                          '18377','80331','74535','21757','29741',
                          '90885','29897','17819','40811','25989',
                          '47513','89531','91067','10391','18845',
                          '99223','82637','41367','83657','86199',
                          '81625','26695','89337','88425','32199',
                          '81427','19053','77471','36609','99823',
                          '43275','41249','48583','83549','82275',
                          '18841','78889','14089','38123','40935',
                          '34425','19849','43285','80071','79187',
                          '54191','11395','50497','84861','90733',
                          '21067','57665','37119','25003','57835',
                          '70067','62877','95805','19303','18839',
                          '19123','29785','16737','16021','49613',
                          '89977','68309','60069','98359','48649',
                          '39049','41793','25001','27413','39735',
                          '47207','16515','94807','57647','15009',
                          '80015','42961','63981','21743','71853',
                          '81087','67467','34175','64007','20261',
                          '11201','51799','48043','45645','61163',
                          '48375','36447','57041','21217','41099',
                          '89951','22745','35851','83325','61125',
                          '78297','80751','49857','52939','96975',
                          '63791','11375','53581','18717','90225',
                          '50529','94203','99447','27669','96577',
                          '57855','56371','16165','23427','54561',
                          '28805','44439','22925','30123','61451',
                          '92397','56979','92309','70873','13355',
                          '21801','46345','37561','56457','28285',
                          '47305','99555','69399','26233','47545',
                          '49661','88601','35943','39935','25631',
                          '24611','44165','56647','30379','59785',
                          '11109','14329','93815','52225','71381',
                          '13841','25611','63293','14663','21077',
                          '82625','18799','60915','81019','56447',
                          '76619','11433','13413','42547','92713',
                          '70467','30883','47483','16071','38935',
                          '13035','88375','45539','35901','19505',
                          '65689','73957','71849','49231','14275',
                          '20005','18383','76615','11635','38177',
                          '55607','41369','95447','58581','58149',
                          '91945','33789','76231','75691','95463',
                          '22245','51061','56691','53121','77209',
                          '15481','10687','14867','45907','73519',
                          '72665','25733','17959','24677','66445',
                          '94627','53535','15559','41967','69297',
                          '11929','59403','33283','52231','57349',
                          '43933','40921','36635','10827','71285',
                          '19735','80619','25251','95041','15525',
                          '36495','55853','49123','81979','35375',
                          '49157','63511','28943','14945','36503',
                          '54009','18767','23969','43905','66979',
                          '33113','21285','58471','59079','13395',
                          '79143','70373','67031','38359','26705',
                          '50905','52405','26065','73145','15883',
                          '31897','30045','61067','45549','92453',
                          '13375','14353','19769','22927','97789',
                          '50723','46081','30201','14409','20223',
                          '88499','67297','13261','14171','81409',
                          '93577','83583','46047','94167','82563',
                          '21155','15799','86709','37931','74703',
                          '83103','23053','70469','72007','49247',
                          '91911','69997','20961','70069','63197',
                          '54853','88191','91829','49521','19453',
                          '81449','89091','62377','25683','61869',
                          '51743','36579','85777','36871','48121',
                          '28809','83711','45485','67393','26935',
                          '42393','20131','55349','86057','21309',
                          '80217','10093','11357','48819','39733',
                          '40757','30431','21203','29467','30213',
                          '61023','55307','74621','11621','68907',
                          '33031','52867','99193','99899','84935',
                          '69035','99149','45013','32895','59003',
                          '32321','14933','32935','33561','72549',
                          '27385','58049','58199','16807','21359',
                          '32961','18585','79307','15491')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


