#!/usr/bin/env bash
# Shebang to just allow refactoring by the ide

# Yq is used to query pom.xml
# `Yq --exit-status` will return a bad exit status and stop the script if no match is found
if ! yq --version >/dev/null 2>&1; then
  echo "yq should be installed"
  return 1
fi

# Project name
# Used by third tool such as api to get the appropriate api key
export PROJECT_NAME="tabulify"


# Git Hooks (modify the .git/config file)
git config core.hooksPath ./.git-hooks
export GIT_REPO=EraldyHq/tabulify

# Used by git-cliff
# https://git-cliff.org/docs/integration/github
export GITHUB_TOKEN
GITHUB_TOKEN=$(pass github/docker-registry)
export GITHUB_REPO=${GIT_REPO}

# SDKMAN
# loading, as it's as the sdk command is a bash function
export SDKMAN_DIR=${SDKMAN_DIR:-"$HOME/.sdkman"}
SDKMAN_INIT_FILE="${SDKMAN_DIR}/bin/sdkman-init.sh"
if [[ ! -s "$SDKMAN_INIT_FILE" ]]; then
  echo "sdkman init file was not found and is mandatory (Path: $SDKMAN_INIT_FILE)"
  echo "You can"
  echo "  * install sdkman"
  echo "  * or overwrite the <.sdkman> dir by setting the SDKMAN_DIR env"
  return 1
fi
# We disable `set -o nounset` to avoid unbound variable errors
set +u
# shellcheck disable=SC1090
source "${SDKMAN_INIT_FILE}"

# Note sdkman vs nix (May be devbox?)
# We don't use nix because the jdk11 package distro is difficult to know and the version to pinpoint
# FYI:
# Nix: OpenJDK Runtime Environment (build 11.0.25+0-adhoc..source)
# Temurin: OpenJDK Runtime Environment Temurin-11.0.26+4 (build 11.0.26+4)



# Java Temurin
# Compilation based on https://github.com/openjdk/jdk11u
export JDK_VERSION
JDK_VERSION=$(yq --exit-status '.project.properties."maven.compiler.target"' pom.xml)
export JRELEASER_PROJECT_LANGUAGES_JAVA_VERSION=${JDK_VERSION}
export JDK_DISTRIBUTION
JDK_DISTRIBUTION=$(yq --exit-status '.project.properties."jdk.distribution"' pom.xml | cut -c 1-3)
SDKMAN_JDK_VERSION="${JDK_VERSION}-${JDK_DISTRIBUTION}"
if ! sdk home java "${SDKMAN_JDK_VERSION}" >/dev/null; then
  sdk install java "${SDKMAN_JDK_VERSION}"
fi
sdk use java "${SDKMAN_JDK_VERSION}"

###################
# Mavens
###################
SDKMAN_MAVEN_VERSION=3.9.9
if ! sdk home maven "${SDKMAN_MAVEN_VERSION}" >/dev/null; then
  sdk install maven "${SDKMAN_MAVEN_VERSION}"
fi
sdk use maven "${SDKMAN_MAVEN_VERSION}"

###################
# JReleaser
###################
JRELEASER_VERSION=$(yq --exit-status '.project.properties."jreleaser.version"' pom.xml)
if ! sdk home jreleaser "${JRELEASER_VERSION}" >/dev/null; then
  sdk install jreleaser "${JRELEASER_VERSION}"
fi
sdk use jreleaser "${JRELEASER_VERSION}"
export JRELEASER_GITHUB_TOKEN
JRELEASER_GITHUB_TOKEN="$GITHUB_TOKEN"
# for the docker upload
export JRELEASER_DOCKER_GHCR_IO_PASSWORD="$GITHUB_TOKEN"
# Same as maven (Default to out)
export JRELEASER_OUTPUT_DIRECTORY=target
# search the .git directory recursively
export JRELEASER_GIT_ROOT_SEARCH=true
# execution directory so that we can execute it from anywhere
# PWD is direnv directory
export JRELEASER_BASEDIR=$PWD/tabulify-cli
if [ ! -f "$JRELEASER_BASEDIR/jreleaser.yml" ]; then
  echo "Bad base dir for Jreleaser"
  return 1
fi
export JRELEASER_GPG_PASSPHRASE
JRELEASER_GPG_PASSPHRASE=$(pass tabulify/jreleaser/gpg-passphrase)

# Cli tabul install (Used by install-cli and doc-exec)
# Cli because TABUL_HOME depends on the context
# In ide development, TABUL_HOME is the ide project root
# In cli,             TABUL_HOME is the cli installation root
export CLI_TABUL_HOME=/opt/tabulify
# Path Should be last in path because tabul comes with a JRE java
# so that we use the jdk of sdkman
export PATH=$PATH:$CLI_TABUL_HOME/bin


# Utility Script
export PATH=$PWD/contrib/script:$PATH

# Java Envs
# Date from java util takes into account the default timezone
# https://learn.microsoft.com/en-us/java/openjdk/timezones#setting-the-tz-environment-variable
export TZ=UTC
# By default, we run in the terminal as local installation
# So no env


# We change the user home so that the documentation has a consistent value across the dev environment (laptops, ci/cd)
export TABUL_OS_USER_HOME=/home/tabulify
if [ ! -d $TABUL_OS_USER_HOME ]; then
  echo "Os User home does not exist. Creating $TABUL_OS_USER_HOME with Sudo"
  sudo mkdir -p $TABUL_OS_USER_HOME
  sudo chown "$USER" "$TABUL_OS_USER_HOME"
fi
export TABUL_USER_HOME="$TABUL_OS_USER_HOME"/.tabul
if [ ! -d $TABUL_USER_HOME ]; then
  echo "Tabul User home does not exist. Creating $TABUL_USER_HOME"
  mkdir -p $TABUL_USER_HOME
fi
